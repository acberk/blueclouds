<html>

<head>

	<title>blueclouds</title>
	<link rel="stylesheet" type="text/css" href="main.css">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

	<link rel="apple-touch-icon-precomposed" sizes="57x57" href="images/apple-touch-icon-57x57.png" />
	<link rel="apple-touch-icon-precomposed" sizes="114x114" href="images/apple-touch-icon-114x114.png" />
	<link rel="apple-touch-icon-precomposed" sizes="72x72" href="images/apple-touch-icon-72x72.png" />
	<link rel="apple-touch-icon-precomposed" sizes="144x144" href="images/apple-touch-icon-144x144.png" />
	<link rel="apple-touch-icon-precomposed" sizes="60x60" href="images/apple-touch-icon-60x60.png" />
	<link rel="apple-touch-icon-precomposed" sizes="120x120" href="images/apple-touch-icon-120x120.png" />
	<link rel="apple-touch-icon-precomposed" sizes="76x76" href="images/apple-touch-icon-76x76.png" />
	<link rel="apple-touch-icon-precomposed" sizes="152x152" href="images/apple-touch-icon-152x152.png" />
	<link rel="icon" type="image/png" href="images/favicon-196x196.png" sizes="196x196" />
	<link rel="icon" type="image/png" href="images/favicon-96x96.png" sizes="96x96" />
	<link rel="icon" type="image/png" href="images/favicon-32x32.png" sizes="32x32" />
	<link rel="icon" type="image/png" href="images/favicon-16x16.png" sizes="16x16" />
	<link rel="icon" type="image/png" href="images/favicon-128.png" sizes="128x128" />
	<meta name="application-name" content="blueclouds" />
	<meta name="msapplication-TileColor" content="#FFFFFF" />
	<meta name="msapplication-TileImage" content="images/mstile-144x144.png" />
	<meta name="msapplication-square70x70logo" content="images/mstile-70x70.png" />
	<meta name="msapplication-square150x150logo" content="images/mstile-150x150.png" />
	<meta name="msapplication-wide310x150logo" content="images/mstile-310x150.png" />
	<meta name="msapplication-square310x310logo" content="images/mstile-310x310.png" />


</head>

<body>
	<div id="content">
		<div class="spinner">
			<div class="bounce1"></div>
			<div class="bounce2"></div>
			<div class="bounce3"></div>
		</div>
		<ul id="hourlyList">
		</ul>
	</div>
	<button title="Back to top" class="scroll fade-out" id="scroll-top">
		<i class="chevron"></i>
	</button>
</body>
<script>
	const scrollButton = document.getElementById('scroll-top')

	scrollButton.addEventListener('click', animateScroll)

	const contentContainer = document.getElementById('content')

	navigator.geolocation.getCurrentPosition(geoSuccess, err => {
		if (err) {
			document.write(err.message)
		}
	})

	window.addEventListener('scroll', evt => {
		if (window.pageYOffset >= 50 && hasClass(scrollButton, 'fade-out')) scrollButton.classList.remove('fade-out')
		else if (window.pageYOffset < 50 && !hasClass(scrollButton, 'fade-out')) scrollButton.classList.add('fade-out')
	})

	window.addEventListener('unhandledrejection', evt => {
		document.write(evt.promise);
		document.write(evt.reason);
	});

	function animateScroll() {
		const scrollTime = Math.min(2.0, Math.max(0.5, window.pageYOffset / 3000))
		contentContainer.style.transition = `top ${scrollTime}s cubic-bezier(0,0,0,1)`
		contentContainer.style.top = `${window.pageYOffset}px`
		setTimeout(() => {
			contentContainer.style.transition = 'none';
			contentContainer.style.top = ''
			window.scrollTo(0, 0)
		}, scrollTime * 1000)
	}

	async function fetchForecastData(url) {
		const response = await fetch(url)
		const json = await response.json()
		return json.properties.periods
	}

	async function geoSuccess(pos) {
		const { latitude, longitude } = pos.coords
		const urlHourly = weatherUrl(latitude, longitude, '/hourly')
		const urlDaily = weatherUrl(latitude, longitude)
		const [hourlyForecast, dailyForecast] = await Promise.all([
			fetchForecastData(urlHourly),
			fetchForecastData(urlDaily)
		])

		let html = getWeekdayHtml(hourlyForecast[0].startTime, dailyForecast)


		for (const p of hourlyForecast) {
			const startTime = formatDate(p.startTime)
			if (startTime === '12:00a') {
				const header = getWeekdayHtml(p.startTime, dailyForecast)
				if (!header) break
				html += header
			}
			html += `
				<li class="hourly">
					<div class="left-detail">
						<img src="${p.icon}"/>
						<span class="time">${startTime}</span>
						<span class="temperature">${p.temperature}&deg;</span>
						<span class="flex-pad"><span>
					</div>
					<div class="right-detail">
					</div>
				</li>
			`

		}

		contentContainer.innerHTML = html

		setupAccordionListener()
	}

	function setupAccordionListener() {
		const accordions = document.getElementsByClassName('accordion')

		for(let i = 0; i < accordions.length; i++) {
			const accordion = accordions[i];
			accordion.addEventListener('click', function(evt) {
				this.classList.toggle('open')
				const collapsibleList = this.nextElementSibling

				if (collapsibleList.style.maxHeight) {
					collapsibleList.style.maxHeight = null
				}
				else {
					collapsibleList.style.maxHeight = collapsibleList.scrollHeight + 'px'
				}
			})
		}

	}

	function formatDate(date) {
		date = parseInt(/T(\d\d)/.exec(date)[1])
		if (date === 0) return '12:00a'
		if (date === 12) return '12:00p'
		if (date > 12) return `${date - 12}:00p`
		return `${date}:00a`
	}

	function getDailyfromDate(dailyForecast, date) {
		const results = {}
		date = /^\d{4}-\d\d-\d\d/.exec(date)[0]
		for (const d of dailyForecast) {
			if (d.startTime.startsWith(date)) {
				results[d.isDaytime ? 'day' : 'night'] = d
			}
		}
		return results
	}

	function getPrecipitation(daily) {
		const dailyVal = daily.day || daily.night
		let precipitation = dailyVal.icon.match(/(,)\d+(?=[\?\/])/g)
		let retVal
		if (precipitation) {
			precipitation = precipitation.map(x=>x.replace(',',''))
			retVal = Math.max(...precipitation)
		}
		return retVal
	}

	function getWeekdayHtml(datetime, dailyForecast) {
		const weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday']
		const daily = getDailyfromDate(dailyForecast, datetime)

		if (!daily.day && !daily.night) return false

		const precipitation = getPrecipitation(daily)
		

		datetime = new Date(datetime)
		const day = weekdays[datetime.getDay()]
		const month = datetime.getMonth() + 1
		const date = datetime.getDate()

		return `
				</ul>
			</div>
			<div>
					<div class="accordion sticky">
						<div class="dayDate">
							<div class="dayMonth">
								<div class="day">${day}</div>
								<div class="month">${month}/${date}</div>
							</div>
							${precipitation ? `<span class="rain">&#9748; ${precipitation}%</span>` : `<span class="flex-pad"></span>`}
							<img src="${(daily.day || daily.night).icon.replace('medium', 'small')}" />
						</div>
						<div class="highLow">
							<div>${daily.day ? daily.day.temperature + '&deg;' : '\xa0'}</div>
							<div>${daily.night ?  daily.night.temperature + '&deg;' : '\xa0'}</div>
						</div>
					</div>
				<ul>
		`
	}

	function hasClass(element, cls) {
		return (' ' + element.className + ' ').indexOf(' ' + cls + ' ') > -1;
	}

	function weatherUrl(lat, lng, endpoint = '') {
		return `https://api.weather.gov/points/${lat.toFixed(4)},${lng.toFixed(4)}/forecast${endpoint}`
	}
</script>

</html>