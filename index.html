<html>

<head>

	<title>blueclouds</title>
	<link rel="stylesheet" type="text/css" href="main.css">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

	<link rel="apple-touch-icon-precomposed" sizes="57x57" href="images/apple-touch-icon-57x57.png" />
	<link rel="apple-touch-icon-precomposed" sizes="114x114" href="images/apple-touch-icon-114x114.png" />
	<link rel="apple-touch-icon-precomposed" sizes="72x72" href="images/apple-touch-icon-72x72.png" />
	<link rel="apple-touch-icon-precomposed" sizes="144x144" href="images/apple-touch-icon-144x144.png" />
	<link rel="apple-touch-icon-precomposed" sizes="60x60" href="images/apple-touch-icon-60x60.png" />
	<link rel="apple-touch-icon-precomposed" sizes="120x120" href="images/apple-touch-icon-120x120.png" />
	<link rel="apple-touch-icon-precomposed" sizes="76x76" href="images/apple-touch-icon-76x76.png" />
	<link rel="apple-touch-icon-precomposed" sizes="152x152" href="images/apple-touch-icon-152x152.png" />
	<link rel="icon" type="image/png" href="images/favicon-196x196.png" sizes="196x196" />
	<link rel="icon" type="image/png" href="images/favicon-96x96.png" sizes="96x96" />
	<link rel="icon" type="image/png" href="images/favicon-32x32.png" sizes="32x32" />
	<link rel="icon" type="image/png" href="images/favicon-16x16.png" sizes="16x16" />
	<link rel="icon" type="image/png" href="images/favicon-128.png" sizes="128x128" />
	<meta name="application-name" content="blueclouds" />
	<meta name="msapplication-TileColor" content="#FFFFFF" />
	<meta name="msapplication-TileImage" content="images/mstile-144x144.png" />
	<meta name="msapplication-square70x70logo" content="images/mstile-70x70.png" />
	<meta name="msapplication-square150x150logo" content="images/mstile-150x150.png" />
	<meta name="msapplication-wide310x150logo" content="images/mstile-310x150.png" />
	<meta name="msapplication-square310x310logo" content="images/mstile-310x310.png" />


</head>

<body>
	<div id="content">
		<article>
			<ul id="tempList">
				<li>
					<div class="spinner">
						<div class="bounce1"></div>
						<div class="bounce2"></div>
						<div class="bounce3"></div>
					</div>
				</li>
			</ul>
		</article>
	</div>
	<button title="Back to top" class="scroll fade-out" id="scroll-top">
		<i class="chevron"></i>
	</button>
</body>
<script>
	const scrollButton = document.getElementById('scroll-top')
	const ul = document.getElementById('tempList')

	scrollButton.addEventListener('click', animateScroll)

	const contentContainer = document.getElementById('content')

	navigator.geolocation.getCurrentPosition(geoSuccess, err => {
		if (err) {
			ul.innerHTML = ''
			console.error(err)
		}
	})

	window.addEventListener('scroll', evt => {
		if (window.pageYOffset >= 50 && hasClass(scrollButton, 'fade-out')) scrollButton.classList.remove('fade-out')
		else if (window.pageYOffset < 50 && !hasClass(scrollButton, 'fade-out')) scrollButton.classList.add('fade-out')
	})

	function animateScroll() {
		const scrollTime = Math.min(2.0, Math.max(0.5, window.pageYOffset / 3000))
		contentContainer.style.transition = `top ${scrollTime}s cubic-bezier(0,0,0,1)`
		contentContainer.style.top = `${window.pageYOffset}px`
		setTimeout(() => {
			contentContainer.style.transition = 'none';
			contentContainer.style.top = ''
			window.scrollTo(0, 0)
		}, scrollTime * 1000)
	}

	async function geoSuccess(pos) {
		const { latitude, longitude } = pos.coords
		const urlHourly = weatherUrl(latitude, longitude, '/hourly')
		const urlDaily = weatherUrl(latitude, longitude)
		const [hourlyForecast, dailyForecast] = await Promise.all([
			(async () => {
				const responseHourly = await fetch(urlHourly)
				const jsonHourly = await responseHourly.json()
				return jsonHourly.properties.periods
			})(),
			(async () => {
				const responseDaily = await fetch(urlDaily)
				const jsonDaily = await responseDaily.json()
				return jsonDaily.properties.periods
			})()
		])

		let html = getWeekdayHtml(hourlyForecast[0].startTime, dailyForecast)

		hourlyForecast.forEach(p => {
			const startTime = formatDate(p.startTime)
			if (startTime === '12:00a') html += getWeekdayHtml(p.startTime, dailyForecast)
			html += `
				<li class="hourly">
					<img src="${p.icon}"/>
					<span class="time">${startTime}</span>
					<span class="temperature">${p.temperature}Â°</span>
				</li>
			`
		})

		contentContainer.innerHTML = html

		setupDetails()
	}

	function setupDetails() {
		const details = document.getElementsByTagName('details')
		// for (const detail of details) {
		// 	detail.addEventListener('toggle', toggleDetails)
		// }

		let isChanging = false


		function toggleDetails(e) {
			if (isChanging) return
			localStorage.setItem('detailsState', e.target.open ? 'open' : '')
			isChanging = true
			for (const detail of details) {
				detail.open = e.target.open
			}
			isChanging = false
		}
	}

	function formatDate(date) {
		date = parseInt(/T(\d\d)/.exec(date)[1])
		if (date === 0) return '12:00a'
		if (date === 12) return '12:00p'
		if (date > 12) return `${date - 12}:00p`
		return `${date}:00a`
	}

	function getDailyfromDate(dailyForecast, date) {
		const results = []
		date = /^\d{4}-\d\d-\d\d/.exec(date)[0]
		dailyForecast.forEach(d => {
			if (d.startTime.startsWith(date)) {
				results.push(d)
			}
		})
		return results
	}

	function getWeekdayHtml(datetime, dailyForecast) {
		const weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday']
		const daily = getDailyfromDate(dailyForecast, datetime)

		datetime = new Date(datetime)
		const day = weekdays[datetime.getDay()]
		const month = datetime.getMonth() + 1
		const date = datetime.getDate()


		return `
			</ul></details>
			<details ${localStorage.getItem('detailsState') || ''}>
				<summary class="sticky">${day} ${month}/${date}
					${daily.map(d => `<img src="${d.icon}"/>`).join('')}
				</summary>
			<ul>
		`
	}

	function hasClass(element, cls) {
		return (' ' + element.className + ' ').indexOf(' ' + cls + ' ') > -1;
	}

	function weatherUrl(lat, lng, endpoint = '') {
		return `https://api.weather.gov/points/${lat.toFixed(4)},${lng.toFixed(4)}/forecast${endpoint}`
	}
</script>

</html>